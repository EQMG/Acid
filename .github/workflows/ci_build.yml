name: build

on:
  push:
    branches:
      - master
      - develop/*
      - release/*
  pull_request:
    branches:
      - master
      - develop/*
      - release/*

jobs:
  windows_msvc:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v2
      with:
       submodules: recursive
    - name: Download Vulkan
      run: |
        Invoke-WebRequest -Uri "https://sdk.lunarg.com/sdk/download/1.2.189.0/windows/VulkanSDK-1.2.189.0-Installer.exe" -OutFile vulkan-sdk.exe
        $installer = Start-Process -FilePath vulkan-sdk.exe -Wait -PassThru -ArgumentList @("/S");
        $installer.WaitForExit();
    - name: Download OpenAL
      run: |
        Invoke-WebRequest -Uri "https://openal-soft.org/openal-binaries/openal-soft-1.22.2-bin.zip" -OutFile openal-soft.zip
        Expand-Archive -Path openal-soft.zip -DestinationPath C:\\
    - name: Build
      env:
        VULKAN_SDK: "C:\\VulkanSDK\\1.2.189.0"
        OPENALDIR: "C:\\openal-soft-1.22.2-bin"
      shell: cmd
      run: |
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
        cmake --version
        ninja --version
        cmake -B Build -GNinja -DACID_LINK_RESOURCES=0 -DACID_INSTALL_RESOURCES=0 -DACID_INSTALL_EXAMPLES=0 -DCMAKE_BUILD_TYPE=Release
        cmake --build Build
    - name: Copy OpenAL32.dll
      shell: cmd
      run: |
        cp .github\workflows\openal\OpenAL32.dll Build\bin\OpenAL32.dll
    - name: Run Tests
      shell: cmd
      run: |
        call "C:\Program Files\Microsoft Visual Studio\2022\Enterprise\VC\Auxiliary\Build\vcvars64.bat"
        cd Build
        ctest
    - name: Install
      run: |
        cmake --install Build --prefix Install --strip
    - name: Pack Zip
      working-directory: Install
      run: |
        cmake -E tar "cvf" "../Windows-MSVC.zip" --format=zip .
    - name: Upload zip
      uses: actions/upload-artifact@v3
      with:
        name: Windows-MSVC.zip
        path: ./Windows-MSVC.zip

  windows_mingw:
    runs-on: windows-latest
    steps:
    - uses: actions/checkout@v2
      with:
       submodules: recursive
    - uses: msys2/setup-msys2@v2
      with:
        update: true
        install: >-
          mingw-w64-x86_64-cmake
          mingw-w64-x86_64-ninja
          mingw-w64-x86_64-msmpi
    - name: Put MSYS2_MinGW64 on PATH
      # there is not yet an environment variable for this path from msys2/setup-msys2
      run: echo "${{ runner.temp }}/msys64/mingw64/bin" | Out-File -FilePath $env:GITHUB_PATH -Encoding utf8 -Append
    - name: Download Vulkan
      run: |
        Invoke-WebRequest -Uri "https://sdk.lunarg.com/sdk/download/1.2.189.0/windows/VulkanSDK-1.2.189.0-Installer.exe" -OutFile vulkan-sdk.exe
        $installer = Start-Process -FilePath vulkan-sdk.exe -Wait -PassThru -ArgumentList @("/S");
        $installer.WaitForExit();
    - name: Download OpenAL
      run: |
        Invoke-WebRequest -Uri "https://openal-soft.org/openal-binaries/openal-soft-1.22.2-bin.zip" -OutFile openal-soft.zip
        Expand-Archive -Path openal-soft.zip -DestinationPath C:\\
    - name: Build
      env:
        VULKAN_SDK: "C:\\VulkanSDK\\1.2.189.0"
        OPENALDIR: "C:\\openal-soft-1.22.2-bin"
      shell: cmd
      run: |
        cmake --version
        ninja --version
        cmake -B Build -GNinja -DACID_LINK_RESOURCES=0 -DACID_INSTALL_RESOURCES=0 -DACID_INSTALL_EXAMPLES=0 -DCMAKE_BUILD_TYPE=Release
        cmake --build Build
    - name: Copy OpenAL32.dll
      shell: cmd
      run: |
        cp .github\workflows\openal\OpenAL32.dll Build\bin\OpenAL32.dll
    - name: Run Tests
      shell: cmd
      run: |
        cd Build
        ctest
    - name: Install
      run: |
        cmake --install Build --prefix Install --strip
    - name: Pack Zip
      working-directory: Install
      run: |
        cmake -E tar "cvf" "../Windows-MinGW.zip" --format=zip .
    - name: Upload zip
      uses: actions/upload-artifact@v3
      with:
        name: Windows-MinGW.zip
        path: ./Windows-MinGW.zip

  linux_clang:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive
    - uses: lukka/get-cmake@v3.19.0
    - name: Download Dependencies
      run: |
        wget https://apt.llvm.org/llvm.sh
        chmod +x llvm.sh
        sudo ./llvm.sh 11
        sudo apt-get install -y build-essential pkg-config g++-10 xorg-dev libglu1-mesa-dev libopenal-dev libvulkan-dev
    - name: Build
      env:
        CC: clang-11
        CXX: clang++-11
        LD_LIBRARY_PATH: /usr/bin/clang++-11/lib
      run: |
        cmake --version
        ninja --version
        cmake -B Build -GNinja -DACID_LINK_RESOURCES=0 -DACID_INSTALL_RESOURCES=0 -DACID_INSTALL_EXAMPLES=0 -DCMAKE_BUILD_TYPE=Release
        cmake --build Build
    - name: Run Tests
      run: |
        cd Build
        ctest
    - name: Install
      run: |
        cmake --install Build --prefix Install --strip
    - name: Pack Zip
      working-directory: Install
      run: |
        cmake -E tar "cvf" "../Linux-Clang.zip" --format=zip .
    - name: Upload zip
      uses: actions/upload-artifact@v3
      with:
        name: Linux-Clang.zip
        path: ./Linux-Clang.zip

  linux_gcc:
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive
    - uses: lukka/get-cmake@v3.19.0
    - name: Download Dependencies
      run: |
        sudo add-apt-repository ppa:ubuntu-toolchain-r/test
        sudo apt-get update -y
        sudo apt-get install -y build-essential pkg-config gcc-10 g++-10 xorg-dev libglu1-mesa-dev libopenal-dev libvulkan-dev
    - name: Build
      env:
        CC: gcc-10
        CXX: g++-10
        LD_LIBRARY_PATH: /usr/bin/g++-10/lib
      run: |
        cmake --version
        ninja --version
        cmake -B Build -GNinja -DACID_LINK_RESOURCES=0 -DACID_INSTALL_RESOURCES=0 -DACID_INSTALL_EXAMPLES=0 -DCMAKE_BUILD_TYPE=Release
        cmake --build Build
    - name: Run Tests
      run: |
        cd Build
        ctest
    - name: Install
      run: |
        cmake --install Build --prefix Install --strip
    - name: Pack Zip
      working-directory: Install
      run: |
        cmake -E tar "cvf" "../Linux-GCC.zip" --format=zip .
    - name: Upload zip
      uses: actions/upload-artifact@v3
      with:
        name: Linux-GCC.zip
        path: ./Linux-GCC.zip

  macos_clang:
    runs-on: macos-latest
    steps:
    - uses: actions/checkout@v2
      with:
        submodules: recursive
    - name: Download Dependencies
      run: |
        /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"
        brew update
        brew tap homebrew/cask
        brew install pkg-config
        brew install openal-soft
        brew install --cask apenngrace/vulkan/vulkan-sdk
    - name: Build
      env:
        CC: clang
        CXX: clang++
      run: |
        cmake --version
        cmake -B Build -G "Xcode" -DACID_LINK_RESOURCES=0 -DACID_INSTALL_RESOURCES=0 -DACID_INSTALL_EXAMPLES=0 -DCMAKE_BUILD_TYPE=Release
        cmake --build Build
    - name: Run Tests
      run: |
        cd Build
        ctest -C Release
    - name: Install
      run: |
        cmake --install Build --prefix Install --strip
    - name: Pack Zip
      working-directory: Install
      run: |
        cmake -E tar "cvf" "../macOS-Clang.zip" --format=zip .
    - name: Upload zip
      uses: actions/upload-artifact@v3
      with:
        name: macOS-Clang.zip
        path: ./macOS-Clang.zip
